<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.11.6" />
<title>tff.convert.scans API documentation</title>
<meta name="description" content="" />
<!-- integrity SRI from https://cdnjs.com/libraries/10up-sanitize.css/11.0.1 -->
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css"
integrity="sha512-kcbluZFacWN57NgWZ4aH6eUMBEaTyErFhIFD3y5qYZbKuuyImH0K/AKsBbfXlivh2z5C+3IDTIhI11YmKomzmA=="
crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css"
integrity="sha512-uVeAgzAmieLUTGba0qr9vXQgVD7fko2kcbYIKIraXUIDg9iJLxveTFUrg3DJhqn3cAf3HFDbgmhq0eGko5wEAA=="
crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML" integrity="sha256-kZafAc6mZvK3W3v1pHOcUix30OHQN6pU/NO2oFkqZVw=" crossorigin></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>tff.convert.scans</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/annotation/text-fabric-factory/blob/87a5452921d16a1d54c01fbf7831c3c5cafce013/tff/convert/scans.py#L1-L400" class="git-link">Browse git</a>
</summary>
<pre><code class="python">from subprocess import run

from tf.core.files import (
    initTree,
    getLocation,
    expanduser as ex,
    dirContents,
    dirExists,
    dirRemove,
    dirCopy,
    dirMake,
    fileExists,
    fileCopy,
    extNm,
    fileRemove,
)
from tf.core.helpers import console, readCfg

from .iiif import FILE_NOT_FOUND


LOGO = &#34;logo&#34;
SCANS = &#34;scans&#34;
SCANINFO = &#34;scanInfo&#34;
THUMB = &#34;thumb&#34;
SCAN_COMMAND = &#34;/opt/homebrew/bin/magick&#34;
IDENTIFY_COMMAND = &#34;/opt/homebrew/bin/identify&#34;
SIZES_OPTIONS = [&#34;-ping&#34;, &#34;-format&#34;, &#34;%w %h&#34;]
COLORSPACE_OPTIONS = [&#34;-ping&#34;, &#34;-format&#34;, &#34;%[colorspace]&#34;]

DS_STORE = &#34;.DS_Store&#34;


class Scans:
    def __init__(
        self,
        verbose=0,
        force=False,
        backend=None,
        org=None,
        repo=None,
        relative=None,
        sourceBase=None,
    ):
        &#34;&#34;&#34;Process scans into thumbnails and detect sizes

        Parameters
        ----------
        backend, org, repo, relative: string, optional None
            If all of these are None, these parameters are derived from the
            current directory.
            If one of them is not None, all four of them are taken from the parameters,
            and the current directory is not used to determine them.
        repoDir: string, optional None
            Directory under which the `scans` directory with scans resides.
            Normally is is computed from the backend, org, repo parameters
            or the location of the current directory, but you can override it
            with this parameter.

        &#34;&#34;&#34;
        if all(s is None for s in (backend, org, repo, relative)):
            (backend, org, repo, relative) = getLocation()
            base = ex(f&#34;~/{backend}&#34;)
            repoDir = f&#34;{base}/{org}/{repo}&#34;
        else:
            repoDir = sourceBase

        if any(s is None for s in (backend, org, repo, relative)):
            console(
                (
                    &#34;Not working in a repo: &#34;
                    f&#34;backend={backend} org={org} repo={repo} relative={relative}&#34;
                ),
                error=True,
            )
            self.good = False
            return

        refDir = f&#34;{repoDir}{relative}&#34;
        sourceRefDir = sourceBase if sourceBase else refDir

        if verbose == 1:
            console(
                f&#34;Working in repository {org}/{repo}{relative} in back-end {backend}&#34;
            )
            console(f&#34;Source dir = {sourceRefDir}&#34;)

        self.good = True

        (ok, settings) = readCfg(
            refDir, &#34;scans&#34;, &#34;imageprep&#34;, verbose=verbose, plain=False
        )
        if not ok:
            self.good = False
            return

        self.settings = settings

        scanDir = f&#34;{sourceRefDir}/{SCANS}&#34;
        scanInfoDir = f&#34;{sourceRefDir}/{SCANINFO}&#34;
        thumbDir = f&#34;{sourceRefDir}/{THUMB}&#34;

        self.scanDir = scanDir
        self.scanInfoDir = scanInfoDir
        self.thumbDir = thumbDir

        self.verbose = verbose
        self.force = force

    def process(self, force=False):
        if not self.good:
            return

        if force is None:
            force = self.force

        verbose = self.verbose
        scanDir = self.scanDir
        scanInfoDir = self.scanInfoDir
        thumbDir = self.thumbDir

        settings = self.settings
        scanExt = settings.scanExt

        plabel = &#34;originals&#34;
        dlabel = &#34;thumbnails&#34;

        for dstDir in (scanInfoDir, thumbDir):
            if force or not dirExists(dstDir):
                dirRemove(dstDir)
                dirMake(dstDir)

            if verbose == 1:
                console(f&#34;Initialized {dstDir}&#34;)
            else:
                if verbose == 1:
                    console(f&#34;{dstDir} already present&#34;)

        (srcFiles, srcSubDirs) = dirContents(scanDir)

        for fl in srcFiles:
            if fl == DS_STORE or fl.startswith(&#34;sizes_&#34;):
                continue

            srcFl = f&#34;{scanDir}/{fl}&#34;
            dstFl = f&#34;{thumbDir}/{fl}&#34;
            fileCopy(srcFl, dstFl)

            if verbose:
                console(f&#34;Copied top level file {fl}&#34;)

        for sbd in srcSubDirs:
            console(f&#34;{sbd}:&#34;)

            srcDir = f&#34;{scanDir}/{sbd}&#34;

            if sbd == LOGO:
                for dstDir in (f&#34;{thumbDir}/{sbd}&#34;, f&#34;{scanInfoDir}/{sbd}&#34;):
                    if force or not dirExists(dstDir):
                        dirRemove(dstDir)
                        dirCopy(srcDir, dstDir)

                        if verbose:
                            console(f&#34;\tCopied subdirectory {sbd}&#34;)

            else:
                sizesFileThumb = f&#34;{thumbDir}/sizes_{sbd}.tsv&#34;
                sizesFileScans = f&#34;{scanDir}/sizes_{sbd}.tsv&#34;
                sizesFileScanInfo = f&#34;{scanInfoDir}/sizes_{sbd}.tsv&#34;
                colorspacesFileScans = f&#34;{scanDir}/colorspaces_{sbd}.tsv&#34;
                colorspacesFileScanInfo = f&#34;{scanInfoDir}/colorspaces_{sbd}.tsv&#34;

                if force or not dirExists(dstDir):
                    self.doThumb(
                        sbd,
                        srcDir,
                        dstDir,
                        scanExt.orig,
                        scanExt.thumb,
                        plabel,
                        dlabel,
                    )
                else:
                    if verbose == 1:
                        console(f&#34;\tAlready present: {dlabel} ({sbd})&#34;)

                if force or not fileExists(sizesFileThumb):
                    self.doSizes(sbd, dstDir, scanExt.thumb, sizesFileThumb, dlabel)
                else:
                    if verbose == 1:
                        console(f&#34;\tAlready present: sizes file {dlabel} ({sbd})&#34;)

                if force or not fileExists(sizesFileScans):
                    self.doSizes(sbd, srcDir, scanExt.orig, sizesFileScans, plabel)
                else:
                    if verbose == 1:
                        console(f&#34;\tAlready present: sizes file {plabel} ({sbd})&#34;)

                if force or not fileExists(sizesFileScanInfo):
                    fileCopy(sizesFileScans, sizesFileScanInfo)
                    console(f&#34;\tCopied sizes_{sbd} file to scanInfo&#34;)
                else:
                    console(f&#34;\tsize_{sbd} file already present in scanInfo&#34;)

                if force or not fileExists(colorspacesFileScans):
                    self.doColorspaces(
                        sbd, srcDir, scanExt.orig, colorspacesFileScans, plabel
                    )
                else:
                    if verbose == 1:
                        console(f&#34;\tAlready present: colorspaces file {plabel} ({sbd})&#34;)

                if force or not fileExists(colorspacesFileScanInfo):
                    self.doColorspaces(
                        sbd, srcDir, scanExt.orig, colorspacesFileScanInfo, plabel
                    )
                else:
                    console(f&#34;\tcolorspaces_{sbd} file already present in scanInfo&#34;)

                for folder, label, ext in (
                    (srcDir, plabel, scanExt.orig),
                    (dstDir, dlabel, scanExt.thumb),
                ):
                    notFound = f&#34;{FILE_NOT_FOUND}.{ext}&#34;
                    files = [
                        f
                        for f in dirContents(folder)[0]
                        if f not in {DS_STORE, notFound} and extNm(f) == ext
                    ]
                    nFiles = len(files)
                    console(f&#34;\t{label}: {nFiles}&#34;)

    def doSizes(self, sbd, imDir, ext, sizesFile, label):
        if not self.good:
            return

        verbose = self.verbose
        fileRemove(sizesFile)

        fileNames = dirContents(imDir)[0]
        items = []

        for fileName in sorted(fileNames):
            if fileName == DS_STORE:
                continue

            thisExt = extNm(fileName)

            if thisExt != ext:
                continue

            base = fileName.removesuffix(f&#34;.{thisExt}&#34;)
            items.append((base, f&#34;{imDir}/{fileName}&#34;))

        console(f&#34;\t\tGet sizes of {len(items)} {label} ({sbd})&#34;)
        j = 0
        nItems = len(items)

        sizes = []

        for i, (base, fromFile) in enumerate(sorted(items)):
            if j == 100:
                perc = int(round(i * 100 / nItems))

                if verbose == 1:
                    console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

                j = 0

            status = run(
                [IDENTIFY_COMMAND] + SIZES_OPTIONS + [fromFile], capture_output=True
            )
            j += 1

            if status.returncode != 0:
                console(f&#34;\t{status.stderr.decode(&#39;utf-8&#39;)}&#34;, error=True)
            else:
                (w, h) = status.stdout.decode(&#34;utf-8&#34;).strip().split()
                sizes.append((base, w, h))

        perc = 100

        if verbose == 1:
            console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

        with open(sizesFile, &#34;w&#34;) as fh:
            fh.write(&#34;file\twidth\theight\n&#34;)

            for file, w, h in sizes:
                fh.write(f&#34;{file}\t{w}\t{h}\n&#34;)

    def doColorspaces(self, sbd, imDir, ext, colorspacesFile, label):
        if not self.good:
            return

        verbose = self.verbose
        fileRemove(colorspacesFile)

        fileNames = dirContents(imDir)[0]
        items = []

        for fileName in sorted(fileNames):
            if fileName == DS_STORE:
                continue

            thisExt = extNm(fileName)

            if thisExt != ext:
                continue

            base = fileName.removesuffix(f&#34;.{thisExt}&#34;)
            items.append((base, f&#34;{imDir}/{fileName}&#34;))

        console(f&#34;\t\tGet colorspaces of {len(items)} {label} ({sbd})&#34;)
        j = 0
        nItems = len(items)

        colorspaces = []

        for i, (base, fromFile) in enumerate(sorted(items)):
            if j == 100:
                perc = int(round(i * 100 / nItems))

                if verbose == 1:
                    console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

                j = 0

            status = run(
                [IDENTIFY_COMMAND] + COLORSPACE_OPTIONS + [fromFile],
                capture_output=True,
            )
            j += 1

            if status.returncode != 0:
                console(f&#34;\t{status.stderr.decode(&#39;utf-8&#39;)}&#34;, error=True)
            else:
                colorspace = status.stdout.decode(&#34;utf-8&#34;).strip()
                colorspaces.append((base, colorspace))

        perc = 100

        if verbose == 1:
            console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

        with open(colorspacesFile, &#34;w&#34;) as fh:
            fh.write(&#34;file\tcolorspace\n&#34;)

            for file, colorspace in colorspaces:
                fh.write(f&#34;{file}\t{colorspace}\n&#34;)

    def doThumb(self, sbd, fromDir, toDir, extIn, extOut, plabel, dlabel):
        if not self.good:
            return

        verbose = self.verbose
        settings = self.settings
        quality = settings.scanQuality
        resize = settings.scanResize

        scanOptions = [&#34;-quality&#34;, quality, &#34;-resize&#34;, resize]

        initTree(toDir, fresh=True)

        fileNames = dirContents(fromDir)[0]
        items = []

        for fileName in sorted(fileNames):
            if fileName == DS_STORE:
                continue

            thisExt = extNm(fileName)
            base = fileName.removesuffix(f&#34;.{thisExt}&#34;)

            if thisExt != extIn:
                continue

            items.append((base, f&#34;{fromDir}/{fileName}&#34;, f&#34;{toDir}/{base}.{extOut}&#34;))

        console(f&#34;\tConvert {len(items)} {plabel} to {dlabel} ({sbd})&#34;)

        j = 0
        nItems = len(items)

        for i, (base, fromFile, toFile) in enumerate(sorted(items)):
            if j == 100:
                perc = int(round(i * 100 / nItems))

                if verbose == 1:
                    console(f&#34;\t\t{perc:&gt;3}% done&#34;)

                j = 0

            run([SCAN_COMMAND] + [fromFile] + scanOptions + [toFile])
            j += 1

        perc = 100

        if verbose == 1:
            console(f&#34;\t\t{perc:&gt;3}% done&#34;)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="tff.convert.scans.Scans"><code class="flex name class">
<span>class <span class="ident">Scans</span></span>
<span>(</span><span>verbose=0, force=False, backend=None, org=None, repo=None, relative=None, sourceBase=None)</span>
</code></dt>
<dd>
<div class="desc"><p>Process scans into thumbnails and detect sizes</p>
<h2 id="parameters">Parameters</h2>
<dl>
<dt><strong><code>backend</code></strong>, <strong><code>org</code></strong>, <strong><code>repo</code></strong>, <strong><code>relative</code></strong> :&ensp;<code>string</code>, optional <code>None</code></dt>
<dd>If all of these are None, these parameters are derived from the
current directory.
If one of them is not None, all four of them are taken from the parameters,
and the current directory is not used to determine them.</dd>
<dt><strong><code>repoDir</code></strong> :&ensp;<code>string</code>, optional <code>None</code></dt>
<dd>Directory under which the <code>scans</code> directory with scans resides.
Normally is is computed from the backend, org, repo parameters
or the location of the current directory, but you can override it
with this parameter.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/annotation/text-fabric-factory/blob/87a5452921d16a1d54c01fbf7831c3c5cafce013/tff/convert/scans.py#L34-L400" class="git-link">Browse git</a>
</summary>
<pre><code class="python">class Scans:
    def __init__(
        self,
        verbose=0,
        force=False,
        backend=None,
        org=None,
        repo=None,
        relative=None,
        sourceBase=None,
    ):
        &#34;&#34;&#34;Process scans into thumbnails and detect sizes

        Parameters
        ----------
        backend, org, repo, relative: string, optional None
            If all of these are None, these parameters are derived from the
            current directory.
            If one of them is not None, all four of them are taken from the parameters,
            and the current directory is not used to determine them.
        repoDir: string, optional None
            Directory under which the `scans` directory with scans resides.
            Normally is is computed from the backend, org, repo parameters
            or the location of the current directory, but you can override it
            with this parameter.

        &#34;&#34;&#34;
        if all(s is None for s in (backend, org, repo, relative)):
            (backend, org, repo, relative) = getLocation()
            base = ex(f&#34;~/{backend}&#34;)
            repoDir = f&#34;{base}/{org}/{repo}&#34;
        else:
            repoDir = sourceBase

        if any(s is None for s in (backend, org, repo, relative)):
            console(
                (
                    &#34;Not working in a repo: &#34;
                    f&#34;backend={backend} org={org} repo={repo} relative={relative}&#34;
                ),
                error=True,
            )
            self.good = False
            return

        refDir = f&#34;{repoDir}{relative}&#34;
        sourceRefDir = sourceBase if sourceBase else refDir

        if verbose == 1:
            console(
                f&#34;Working in repository {org}/{repo}{relative} in back-end {backend}&#34;
            )
            console(f&#34;Source dir = {sourceRefDir}&#34;)

        self.good = True

        (ok, settings) = readCfg(
            refDir, &#34;scans&#34;, &#34;imageprep&#34;, verbose=verbose, plain=False
        )
        if not ok:
            self.good = False
            return

        self.settings = settings

        scanDir = f&#34;{sourceRefDir}/{SCANS}&#34;
        scanInfoDir = f&#34;{sourceRefDir}/{SCANINFO}&#34;
        thumbDir = f&#34;{sourceRefDir}/{THUMB}&#34;

        self.scanDir = scanDir
        self.scanInfoDir = scanInfoDir
        self.thumbDir = thumbDir

        self.verbose = verbose
        self.force = force

    def process(self, force=False):
        if not self.good:
            return

        if force is None:
            force = self.force

        verbose = self.verbose
        scanDir = self.scanDir
        scanInfoDir = self.scanInfoDir
        thumbDir = self.thumbDir

        settings = self.settings
        scanExt = settings.scanExt

        plabel = &#34;originals&#34;
        dlabel = &#34;thumbnails&#34;

        for dstDir in (scanInfoDir, thumbDir):
            if force or not dirExists(dstDir):
                dirRemove(dstDir)
                dirMake(dstDir)

            if verbose == 1:
                console(f&#34;Initialized {dstDir}&#34;)
            else:
                if verbose == 1:
                    console(f&#34;{dstDir} already present&#34;)

        (srcFiles, srcSubDirs) = dirContents(scanDir)

        for fl in srcFiles:
            if fl == DS_STORE or fl.startswith(&#34;sizes_&#34;):
                continue

            srcFl = f&#34;{scanDir}/{fl}&#34;
            dstFl = f&#34;{thumbDir}/{fl}&#34;
            fileCopy(srcFl, dstFl)

            if verbose:
                console(f&#34;Copied top level file {fl}&#34;)

        for sbd in srcSubDirs:
            console(f&#34;{sbd}:&#34;)

            srcDir = f&#34;{scanDir}/{sbd}&#34;

            if sbd == LOGO:
                for dstDir in (f&#34;{thumbDir}/{sbd}&#34;, f&#34;{scanInfoDir}/{sbd}&#34;):
                    if force or not dirExists(dstDir):
                        dirRemove(dstDir)
                        dirCopy(srcDir, dstDir)

                        if verbose:
                            console(f&#34;\tCopied subdirectory {sbd}&#34;)

            else:
                sizesFileThumb = f&#34;{thumbDir}/sizes_{sbd}.tsv&#34;
                sizesFileScans = f&#34;{scanDir}/sizes_{sbd}.tsv&#34;
                sizesFileScanInfo = f&#34;{scanInfoDir}/sizes_{sbd}.tsv&#34;
                colorspacesFileScans = f&#34;{scanDir}/colorspaces_{sbd}.tsv&#34;
                colorspacesFileScanInfo = f&#34;{scanInfoDir}/colorspaces_{sbd}.tsv&#34;

                if force or not dirExists(dstDir):
                    self.doThumb(
                        sbd,
                        srcDir,
                        dstDir,
                        scanExt.orig,
                        scanExt.thumb,
                        plabel,
                        dlabel,
                    )
                else:
                    if verbose == 1:
                        console(f&#34;\tAlready present: {dlabel} ({sbd})&#34;)

                if force or not fileExists(sizesFileThumb):
                    self.doSizes(sbd, dstDir, scanExt.thumb, sizesFileThumb, dlabel)
                else:
                    if verbose == 1:
                        console(f&#34;\tAlready present: sizes file {dlabel} ({sbd})&#34;)

                if force or not fileExists(sizesFileScans):
                    self.doSizes(sbd, srcDir, scanExt.orig, sizesFileScans, plabel)
                else:
                    if verbose == 1:
                        console(f&#34;\tAlready present: sizes file {plabel} ({sbd})&#34;)

                if force or not fileExists(sizesFileScanInfo):
                    fileCopy(sizesFileScans, sizesFileScanInfo)
                    console(f&#34;\tCopied sizes_{sbd} file to scanInfo&#34;)
                else:
                    console(f&#34;\tsize_{sbd} file already present in scanInfo&#34;)

                if force or not fileExists(colorspacesFileScans):
                    self.doColorspaces(
                        sbd, srcDir, scanExt.orig, colorspacesFileScans, plabel
                    )
                else:
                    if verbose == 1:
                        console(f&#34;\tAlready present: colorspaces file {plabel} ({sbd})&#34;)

                if force or not fileExists(colorspacesFileScanInfo):
                    self.doColorspaces(
                        sbd, srcDir, scanExt.orig, colorspacesFileScanInfo, plabel
                    )
                else:
                    console(f&#34;\tcolorspaces_{sbd} file already present in scanInfo&#34;)

                for folder, label, ext in (
                    (srcDir, plabel, scanExt.orig),
                    (dstDir, dlabel, scanExt.thumb),
                ):
                    notFound = f&#34;{FILE_NOT_FOUND}.{ext}&#34;
                    files = [
                        f
                        for f in dirContents(folder)[0]
                        if f not in {DS_STORE, notFound} and extNm(f) == ext
                    ]
                    nFiles = len(files)
                    console(f&#34;\t{label}: {nFiles}&#34;)

    def doSizes(self, sbd, imDir, ext, sizesFile, label):
        if not self.good:
            return

        verbose = self.verbose
        fileRemove(sizesFile)

        fileNames = dirContents(imDir)[0]
        items = []

        for fileName in sorted(fileNames):
            if fileName == DS_STORE:
                continue

            thisExt = extNm(fileName)

            if thisExt != ext:
                continue

            base = fileName.removesuffix(f&#34;.{thisExt}&#34;)
            items.append((base, f&#34;{imDir}/{fileName}&#34;))

        console(f&#34;\t\tGet sizes of {len(items)} {label} ({sbd})&#34;)
        j = 0
        nItems = len(items)

        sizes = []

        for i, (base, fromFile) in enumerate(sorted(items)):
            if j == 100:
                perc = int(round(i * 100 / nItems))

                if verbose == 1:
                    console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

                j = 0

            status = run(
                [IDENTIFY_COMMAND] + SIZES_OPTIONS + [fromFile], capture_output=True
            )
            j += 1

            if status.returncode != 0:
                console(f&#34;\t{status.stderr.decode(&#39;utf-8&#39;)}&#34;, error=True)
            else:
                (w, h) = status.stdout.decode(&#34;utf-8&#34;).strip().split()
                sizes.append((base, w, h))

        perc = 100

        if verbose == 1:
            console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

        with open(sizesFile, &#34;w&#34;) as fh:
            fh.write(&#34;file\twidth\theight\n&#34;)

            for file, w, h in sizes:
                fh.write(f&#34;{file}\t{w}\t{h}\n&#34;)

    def doColorspaces(self, sbd, imDir, ext, colorspacesFile, label):
        if not self.good:
            return

        verbose = self.verbose
        fileRemove(colorspacesFile)

        fileNames = dirContents(imDir)[0]
        items = []

        for fileName in sorted(fileNames):
            if fileName == DS_STORE:
                continue

            thisExt = extNm(fileName)

            if thisExt != ext:
                continue

            base = fileName.removesuffix(f&#34;.{thisExt}&#34;)
            items.append((base, f&#34;{imDir}/{fileName}&#34;))

        console(f&#34;\t\tGet colorspaces of {len(items)} {label} ({sbd})&#34;)
        j = 0
        nItems = len(items)

        colorspaces = []

        for i, (base, fromFile) in enumerate(sorted(items)):
            if j == 100:
                perc = int(round(i * 100 / nItems))

                if verbose == 1:
                    console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

                j = 0

            status = run(
                [IDENTIFY_COMMAND] + COLORSPACE_OPTIONS + [fromFile],
                capture_output=True,
            )
            j += 1

            if status.returncode != 0:
                console(f&#34;\t{status.stderr.decode(&#39;utf-8&#39;)}&#34;, error=True)
            else:
                colorspace = status.stdout.decode(&#34;utf-8&#34;).strip()
                colorspaces.append((base, colorspace))

        perc = 100

        if verbose == 1:
            console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

        with open(colorspacesFile, &#34;w&#34;) as fh:
            fh.write(&#34;file\tcolorspace\n&#34;)

            for file, colorspace in colorspaces:
                fh.write(f&#34;{file}\t{colorspace}\n&#34;)

    def doThumb(self, sbd, fromDir, toDir, extIn, extOut, plabel, dlabel):
        if not self.good:
            return

        verbose = self.verbose
        settings = self.settings
        quality = settings.scanQuality
        resize = settings.scanResize

        scanOptions = [&#34;-quality&#34;, quality, &#34;-resize&#34;, resize]

        initTree(toDir, fresh=True)

        fileNames = dirContents(fromDir)[0]
        items = []

        for fileName in sorted(fileNames):
            if fileName == DS_STORE:
                continue

            thisExt = extNm(fileName)
            base = fileName.removesuffix(f&#34;.{thisExt}&#34;)

            if thisExt != extIn:
                continue

            items.append((base, f&#34;{fromDir}/{fileName}&#34;, f&#34;{toDir}/{base}.{extOut}&#34;))

        console(f&#34;\tConvert {len(items)} {plabel} to {dlabel} ({sbd})&#34;)

        j = 0
        nItems = len(items)

        for i, (base, fromFile, toFile) in enumerate(sorted(items)):
            if j == 100:
                perc = int(round(i * 100 / nItems))

                if verbose == 1:
                    console(f&#34;\t\t{perc:&gt;3}% done&#34;)

                j = 0

            run([SCAN_COMMAND] + [fromFile] + scanOptions + [toFile])
            j += 1

        perc = 100

        if verbose == 1:
            console(f&#34;\t\t{perc:&gt;3}% done&#34;)</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="tff.convert.scans.Scans.doColorspaces"><code class="name flex">
<span>def <span class="ident">doColorspaces</span></span>(<span>self, sbd, imDir, ext, colorspacesFile, label)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/annotation/text-fabric-factory/blob/87a5452921d16a1d54c01fbf7831c3c5cafce013/tff/convert/scans.py#L292-L350" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def doColorspaces(self, sbd, imDir, ext, colorspacesFile, label):
    if not self.good:
        return

    verbose = self.verbose
    fileRemove(colorspacesFile)

    fileNames = dirContents(imDir)[0]
    items = []

    for fileName in sorted(fileNames):
        if fileName == DS_STORE:
            continue

        thisExt = extNm(fileName)

        if thisExt != ext:
            continue

        base = fileName.removesuffix(f&#34;.{thisExt}&#34;)
        items.append((base, f&#34;{imDir}/{fileName}&#34;))

    console(f&#34;\t\tGet colorspaces of {len(items)} {label} ({sbd})&#34;)
    j = 0
    nItems = len(items)

    colorspaces = []

    for i, (base, fromFile) in enumerate(sorted(items)):
        if j == 100:
            perc = int(round(i * 100 / nItems))

            if verbose == 1:
                console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

            j = 0

        status = run(
            [IDENTIFY_COMMAND] + COLORSPACE_OPTIONS + [fromFile],
            capture_output=True,
        )
        j += 1

        if status.returncode != 0:
            console(f&#34;\t{status.stderr.decode(&#39;utf-8&#39;)}&#34;, error=True)
        else:
            colorspace = status.stdout.decode(&#34;utf-8&#34;).strip()
            colorspaces.append((base, colorspace))

    perc = 100

    if verbose == 1:
        console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

    with open(colorspacesFile, &#34;w&#34;) as fh:
        fh.write(&#34;file\tcolorspace\n&#34;)

        for file, colorspace in colorspaces:
            fh.write(f&#34;{file}\t{colorspace}\n&#34;)</code></pre>
</details>
</dd>
<dt id="tff.convert.scans.Scans.doSizes"><code class="name flex">
<span>def <span class="ident">doSizes</span></span>(<span>self, sbd, imDir, ext, sizesFile, label)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/annotation/text-fabric-factory/blob/87a5452921d16a1d54c01fbf7831c3c5cafce013/tff/convert/scans.py#L233-L290" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def doSizes(self, sbd, imDir, ext, sizesFile, label):
    if not self.good:
        return

    verbose = self.verbose
    fileRemove(sizesFile)

    fileNames = dirContents(imDir)[0]
    items = []

    for fileName in sorted(fileNames):
        if fileName == DS_STORE:
            continue

        thisExt = extNm(fileName)

        if thisExt != ext:
            continue

        base = fileName.removesuffix(f&#34;.{thisExt}&#34;)
        items.append((base, f&#34;{imDir}/{fileName}&#34;))

    console(f&#34;\t\tGet sizes of {len(items)} {label} ({sbd})&#34;)
    j = 0
    nItems = len(items)

    sizes = []

    for i, (base, fromFile) in enumerate(sorted(items)):
        if j == 100:
            perc = int(round(i * 100 / nItems))

            if verbose == 1:
                console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

            j = 0

        status = run(
            [IDENTIFY_COMMAND] + SIZES_OPTIONS + [fromFile], capture_output=True
        )
        j += 1

        if status.returncode != 0:
            console(f&#34;\t{status.stderr.decode(&#39;utf-8&#39;)}&#34;, error=True)
        else:
            (w, h) = status.stdout.decode(&#34;utf-8&#34;).strip().split()
            sizes.append((base, w, h))

    perc = 100

    if verbose == 1:
        console(f&#34;\t\t\t{perc:&gt;3}% done&#34;)

    with open(sizesFile, &#34;w&#34;) as fh:
        fh.write(&#34;file\twidth\theight\n&#34;)

        for file, w, h in sizes:
            fh.write(f&#34;{file}\t{w}\t{h}\n&#34;)</code></pre>
</details>
</dd>
<dt id="tff.convert.scans.Scans.doThumb"><code class="name flex">
<span>def <span class="ident">doThumb</span></span>(<span>self, sbd, fromDir, toDir, extIn, extOut, plabel, dlabel)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/annotation/text-fabric-factory/blob/87a5452921d16a1d54c01fbf7831c3c5cafce013/tff/convert/scans.py#L352-L400" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def doThumb(self, sbd, fromDir, toDir, extIn, extOut, plabel, dlabel):
    if not self.good:
        return

    verbose = self.verbose
    settings = self.settings
    quality = settings.scanQuality
    resize = settings.scanResize

    scanOptions = [&#34;-quality&#34;, quality, &#34;-resize&#34;, resize]

    initTree(toDir, fresh=True)

    fileNames = dirContents(fromDir)[0]
    items = []

    for fileName in sorted(fileNames):
        if fileName == DS_STORE:
            continue

        thisExt = extNm(fileName)
        base = fileName.removesuffix(f&#34;.{thisExt}&#34;)

        if thisExt != extIn:
            continue

        items.append((base, f&#34;{fromDir}/{fileName}&#34;, f&#34;{toDir}/{base}.{extOut}&#34;))

    console(f&#34;\tConvert {len(items)} {plabel} to {dlabel} ({sbd})&#34;)

    j = 0
    nItems = len(items)

    for i, (base, fromFile, toFile) in enumerate(sorted(items)):
        if j == 100:
            perc = int(round(i * 100 / nItems))

            if verbose == 1:
                console(f&#34;\t\t{perc:&gt;3}% done&#34;)

            j = 0

        run([SCAN_COMMAND] + [fromFile] + scanOptions + [toFile])
        j += 1

    perc = 100

    if verbose == 1:
        console(f&#34;\t\t{perc:&gt;3}% done&#34;)</code></pre>
</details>
</dd>
<dt id="tff.convert.scans.Scans.process"><code class="name flex">
<span>def <span class="ident">process</span></span>(<span>self, force=False)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
<a href="https://github.com/annotation/text-fabric-factory/blob/87a5452921d16a1d54c01fbf7831c3c5cafce013/tff/convert/scans.py#L110-L231" class="git-link">Browse git</a>
</summary>
<pre><code class="python">def process(self, force=False):
    if not self.good:
        return

    if force is None:
        force = self.force

    verbose = self.verbose
    scanDir = self.scanDir
    scanInfoDir = self.scanInfoDir
    thumbDir = self.thumbDir

    settings = self.settings
    scanExt = settings.scanExt

    plabel = &#34;originals&#34;
    dlabel = &#34;thumbnails&#34;

    for dstDir in (scanInfoDir, thumbDir):
        if force or not dirExists(dstDir):
            dirRemove(dstDir)
            dirMake(dstDir)

        if verbose == 1:
            console(f&#34;Initialized {dstDir}&#34;)
        else:
            if verbose == 1:
                console(f&#34;{dstDir} already present&#34;)

    (srcFiles, srcSubDirs) = dirContents(scanDir)

    for fl in srcFiles:
        if fl == DS_STORE or fl.startswith(&#34;sizes_&#34;):
            continue

        srcFl = f&#34;{scanDir}/{fl}&#34;
        dstFl = f&#34;{thumbDir}/{fl}&#34;
        fileCopy(srcFl, dstFl)

        if verbose:
            console(f&#34;Copied top level file {fl}&#34;)

    for sbd in srcSubDirs:
        console(f&#34;{sbd}:&#34;)

        srcDir = f&#34;{scanDir}/{sbd}&#34;

        if sbd == LOGO:
            for dstDir in (f&#34;{thumbDir}/{sbd}&#34;, f&#34;{scanInfoDir}/{sbd}&#34;):
                if force or not dirExists(dstDir):
                    dirRemove(dstDir)
                    dirCopy(srcDir, dstDir)

                    if verbose:
                        console(f&#34;\tCopied subdirectory {sbd}&#34;)

        else:
            sizesFileThumb = f&#34;{thumbDir}/sizes_{sbd}.tsv&#34;
            sizesFileScans = f&#34;{scanDir}/sizes_{sbd}.tsv&#34;
            sizesFileScanInfo = f&#34;{scanInfoDir}/sizes_{sbd}.tsv&#34;
            colorspacesFileScans = f&#34;{scanDir}/colorspaces_{sbd}.tsv&#34;
            colorspacesFileScanInfo = f&#34;{scanInfoDir}/colorspaces_{sbd}.tsv&#34;

            if force or not dirExists(dstDir):
                self.doThumb(
                    sbd,
                    srcDir,
                    dstDir,
                    scanExt.orig,
                    scanExt.thumb,
                    plabel,
                    dlabel,
                )
            else:
                if verbose == 1:
                    console(f&#34;\tAlready present: {dlabel} ({sbd})&#34;)

            if force or not fileExists(sizesFileThumb):
                self.doSizes(sbd, dstDir, scanExt.thumb, sizesFileThumb, dlabel)
            else:
                if verbose == 1:
                    console(f&#34;\tAlready present: sizes file {dlabel} ({sbd})&#34;)

            if force or not fileExists(sizesFileScans):
                self.doSizes(sbd, srcDir, scanExt.orig, sizesFileScans, plabel)
            else:
                if verbose == 1:
                    console(f&#34;\tAlready present: sizes file {plabel} ({sbd})&#34;)

            if force or not fileExists(sizesFileScanInfo):
                fileCopy(sizesFileScans, sizesFileScanInfo)
                console(f&#34;\tCopied sizes_{sbd} file to scanInfo&#34;)
            else:
                console(f&#34;\tsize_{sbd} file already present in scanInfo&#34;)

            if force or not fileExists(colorspacesFileScans):
                self.doColorspaces(
                    sbd, srcDir, scanExt.orig, colorspacesFileScans, plabel
                )
            else:
                if verbose == 1:
                    console(f&#34;\tAlready present: colorspaces file {plabel} ({sbd})&#34;)

            if force or not fileExists(colorspacesFileScanInfo):
                self.doColorspaces(
                    sbd, srcDir, scanExt.orig, colorspacesFileScanInfo, plabel
                )
            else:
                console(f&#34;\tcolorspaces_{sbd} file already present in scanInfo&#34;)

            for folder, label, ext in (
                (srcDir, plabel, scanExt.orig),
                (dstDir, dlabel, scanExt.thumb),
            ):
                notFound = f&#34;{FILE_NOT_FOUND}.{ext}&#34;
                files = [
                    f
                    for f in dirContents(folder)[0]
                    if f not in {DS_STORE, notFound} and extNm(f) == ext
                ]
                nFiles = len(files)
                console(f&#34;\t{label}: {nFiles}&#34;)</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<p><a href="https://github.com/annotation" title="annotation on GitHub"><img src="../../tff/images/tf-small.png" alt="annotation"></a></p>
<p><a href="../../tff/index.html">tff home</a> -
<a href="../../tff/cheatsheet.html">cheat sheet</a> -
<a href="https://github.com/annotation/text-fabric-factory" title="GitHub repo"><img src="../../tff/images/GitHub_Logo.png" alt="GitHub" width="50"></a></p>
</p>
<form>
<input id="lunr-search" name="q" placeholder="🔎 Search ..." aria-label="Search"
disabled minlength="2">
</form>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.15.3/tingle.min.css" integrity="sha512-j1u8eUJ4f23xPPxwOrLUPQaCD2dwzNqqmDDcWS4deWsMv2ohLqmXXuP3hU7g8TyzbMSakP/mMqoNBYWj8AEIFg==" crossorigin>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tingle/0.15.3/tingle.min.js" integrity="sha512-plGUER9JkeEWPPqQBE4sdLqBoQug5Ap+BCGMc7bJ8BXkm+VVj6QzkpBz5Yv2yPkkq+cqg9IpkBaGCas6uDbW8g==" crossorigin></script>
<style>
.modal-dialog iframe {
width: 100vw;
height: calc(100vh - 80px);
}
@media screen and (min-width: 700px) {
.modal-dialog iframe {
width: 70vw;
height: 80vh;
}
}
.modal-dialog .tingle-modal-box {width: auto;}
.modal-dialog .tingle-modal-box__content {padding: 0;}
</style>
<script>
const input = document.getElementById('lunr-search');
input.disabled = false;
input.form.addEventListener('submit', (ev) => {
ev.preventDefault();
const url = new URL(window.location);
url.searchParams.set('q', input.value);
history.replaceState({}, null, url.toString());
search(input.value);
});
const query = new URL(window.location).searchParams.get('q');
if (query)
search(query);
function search(query) {
const url = '../../doc-search.html#' + encodeURIComponent(query);
new tingle.modal({
cssClass: ['modal-dialog'],
onClose: () => {
const url = new URL(window.location);
url.searchParams.delete('q');
history.replaceState({}, null, url.toString());
setTimeout(() => input.focus(), 100);
}
}).setContent('<iframe src="' + url + '"></iframe>').open();
}
</script>
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="tff.convert" href="index.html">tff.convert</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="tff.convert.scans.Scans" href="#tff.convert.scans.Scans">Scans</a></code></h4>
<ul class="">
<li><code><a title="tff.convert.scans.Scans.doColorspaces" href="#tff.convert.scans.Scans.doColorspaces">doColorspaces</a></code></li>
<li><code><a title="tff.convert.scans.Scans.doSizes" href="#tff.convert.scans.Scans.doSizes">doSizes</a></code></li>
<li><code><a title="tff.convert.scans.Scans.doThumb" href="#tff.convert.scans.Scans.doThumb">doThumb</a></code></li>
<li><code><a title="tff.convert.scans.Scans.process" href="#tff.convert.scans.Scans.process">process</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<a href="https://pure.knaw.nl/portal/en/persons/dirk-roorda">Dirk Roorda</a>
<a href="https://huc.knaw.nl"><img alt="HuC" src="../../tff/images/huc.png" width="200" alt="Humanities Cluster"></a>
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.11.6</a>.</p>
</footer>
</body>
</html>
